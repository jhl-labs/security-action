name: Security Check

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    - cron: '0 0 * * 0'  # ë§¤ì£¼ ì¼ìš”ì¼ ìžì • (UTC)
  workflow_dispatch:
    inputs:
      runs_on_json:
        description: 'Optional runner labels (JSON array or single label, ex: ["self-hosted","linux","jhl-space"] or jhl-space)'
        required: false
        default: ''

concurrency:
  group: security-check-${{ github.ref }}
  cancel-in-progress: true

# =============================================================================
# ðŸ›¡ï¸ Security Report - Required Status Check
# Settings â†’ Branches â†’ Branch protection rules â†’ "ðŸ›¡ï¸ Security Report"
# Runner override:
#   Repository Variables -> SECURITY_ACTION_RUNS_ON_JSON
#   Example: ["self-hosted","linux","jhl-space"] or jhl-space
# Manual override (workflow_dispatch):
#   runs_on_json input (empty = use repository variable/default)
# =============================================================================

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # ðŸ›¡ï¸ Security Jobs
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  security-scan:
    name: ðŸ›¡ï¸ Security Scan
    runs-on: ${{ fromJSON((github.event_name == 'workflow_dispatch' && github.event.inputs.runs_on_json && (startsWith(github.event.inputs.runs_on_json, '[') && github.event.inputs.runs_on_json || format('["{0}"]', github.event.inputs.runs_on_json))) || (vars.SECURITY_ACTION_RUNS_ON_JSON && (startsWith(vars.SECURITY_ACTION_RUNS_ON_JSON, '[') && vars.SECURITY_ACTION_RUNS_ON_JSON || format('["{0}"]', vars.SECURITY_ACTION_RUNS_ON_JSON))) || '["ubuntu-latest"]') }}
    timeout-minutes: 25
    permissions:
      contents: read
      pull-requests: write
      checks: write
      statuses: write

    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0

      - name: Run Security Scan
        id: scan
        uses: ./
        with:
          # ê¸°ë³¸ ìŠ¤ìºë„ˆ (ëª¨ë‘ í™œì„±í™”)
          secret-scan: 'true'
          # push/PRì—ì„œëŠ” í˜„ìž¬ ì½”ë“œë§Œ ìŠ¤ìº”í•´ ì‹œê°„ì„ ì¤„ì´ê³ ,
          # ì£¼ê¸° ìŠ¤ìº”(schedule)ì—ì„œë§Œ ížˆìŠ¤í† ë¦¬ ì „ì²´ ìŠ¤ìº”ì„ ìˆ˜í–‰
          secret-scan-history: ${{ github.event_name == 'schedule' }}
          code-scan: 'true'
          dependency-scan: 'true'

          # IaC ìŠ¤ìº” (í”„ë ˆìž„ì›Œí¬ ëª…ì‹œ)
          iac-scan: 'true'
          iac-frameworks: 'dockerfile,github_actions,kubernetes'

          # ë„¤ì´í‹°ë¸Œ ì˜ì¡´ì„± ìŠ¤ìº” (npm audit, pip-audit ë“±)
          native-audit: 'true'
          native-audit-tools: 'auto'

          # SBOM ìƒì„±
          sbom-generate: 'true'
          sbom-format: 'cyclonedx-json'
          sbom-output: 'sbom.json'

          # SonarQube (ì„œë²„ í•„ìš” - ë¹„í™œì„±í™”)
          # sonar-scan: 'true'
          # sonar-host-url: ${{ secrets.SONAR_HOST_URL }}
          # sonar-token: ${{ secrets.SONAR_TOKEN }}
          # sonar-project-key: 'security-action'

          # AI ë¦¬ë·° (API í‚¤ í•„ìš” - ë¹„í™œì„±í™”)
          # ai-review: 'true'
          # ai-provider: 'openai'
          # ai-model: ${{ secrets.AI_MODEL }}
          # openai-api-key: ${{ secrets.OPENAI_API_KEY }}
          # openai-base-url: ${{ secrets.OPENAI_BASE_URL }}
          # anthropic-api-key: ${{ secrets.ANTHROPIC_API_KEY }}

          # ê³µí†µ ì„¤ì •
          check-name: 'ðŸ›¡ï¸ Security Report'
          severity-threshold: 'high'
          fail-on-findings: 'false'
          post-summary: 'false'  # Summary Jobì—ì„œ í†µí•© ë¦¬í¬íŠ¸ ìƒì„±
          sarif-output: 'security-results.sarif'
          upload-sarif: 'false'  # Private repo ê¸°ë³¸: GHAS/Code Security ì—†ìœ¼ë©´ ì—…ë¡œë“œ ì‹¤íŒ¨ ê°€ëŠ¥
          sarif-category: 'security-scan'
          fail-on-sarif-upload-error: 'false'
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload SBOM Artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        if: always()
        with:
          name: sbom-source
          path: sbom.json
          retention-days: 90

      - name: Upload SARIF Artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        if: always()
        with:
          name: sarif-security
          path: security-results.sarif
          retention-days: 90

    outputs:
      findings-count: ${{ steps.scan.outputs.findings-count }}
      critical-count: ${{ steps.scan.outputs.critical-count }}
      high-count: ${{ steps.scan.outputs.high-count }}
      sarif-file: ${{ steps.scan.outputs.sarif-file }}
      sarif-upload-id: ${{ steps.scan.outputs.sarif-upload-id }}
      sbom-file: ${{ steps.scan.outputs.sbom-file }}

  container-scan:
    name: ðŸ›¡ï¸ Container Scan
    runs-on: ${{ fromJSON((github.event_name == 'workflow_dispatch' && github.event.inputs.runs_on_json && (startsWith(github.event.inputs.runs_on_json, '[') && github.event.inputs.runs_on_json || format('["{0}"]', github.event.inputs.runs_on_json))) || (vars.SECURITY_ACTION_RUNS_ON_JSON && (startsWith(vars.SECURITY_ACTION_RUNS_ON_JSON, '[') && vars.SECURITY_ACTION_RUNS_ON_JSON || format('["{0}"]', vars.SECURITY_ACTION_RUNS_ON_JSON))) || '["ubuntu-latest"]') }}
    timeout-minutes: 30
    permissions:
      contents: read
      checks: write
      statuses: write

    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435 # v3.11.1

      - name: Build Image for Scan
        uses: docker/build-push-action@ca052bb54ab0790a636c9b5f226502c73d547a25 # v5.4.0
        with:
          context: .
          push: false
          load: true
          tags: security-action:scan
          provenance: false
          cache-from: type=gha
          cache-to: type=gha,mode=min

      - name: Run Container Scan
        id: scan
        uses: ./
        with:
          # ê¸°ë³¸ ìŠ¤ìºë„ˆ ë¹„í™œì„±í™” (security-scanì—ì„œ ì²˜ë¦¬)
          secret-scan: 'false'
          code-scan: 'false'
          dependency-scan: 'false'

          # ì»¨í…Œì´ë„ˆ ìŠ¤ìº” í™œì„±í™”
          container-scan: 'true'
          container-image: 'security-action:scan'

          # ì»¨í…Œì´ë„ˆ SBOM ìƒì„±
          sbom-generate: 'true'
          sbom-format: 'cyclonedx-json'
          sbom-output: 'container-sbom.json'

          # ê³µí†µ ì„¤ì •
          skip-check: 'true'  # Required Check ê±´ë„ˆëœ€ (security-scanì—ì„œ ìƒì„±)
          severity-threshold: 'critical'
          fail-on-findings: 'false'
          post-summary: 'false'  # Summary Jobì—ì„œ í†µí•© ë¦¬í¬íŠ¸ ìƒì„±
          sarif-output: 'container-scan.sarif'
          upload-sarif: 'false'  # í•„ìš” ì‹œ trueë¡œ í™œì„±í™”
          sarif-category: 'container-scan'
          fail-on-sarif-upload-error: 'false'
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Container SBOM Artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        if: always()
        with:
          name: sbom-container
          path: container-sbom.json
          retention-days: 90

      - name: Upload Container SARIF Artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        if: always()
        with:
          name: sarif-container
          path: container-scan.sarif
          retention-days: 90

    outputs:
      findings-count: ${{ steps.scan.outputs.findings-count }}
      critical-count: ${{ steps.scan.outputs.critical-count }}
      high-count: ${{ steps.scan.outputs.high-count }}
      sarif-upload-id: ${{ steps.scan.outputs.sarif-upload-id }}

  lint:
    name: ðŸ”§ Lint
    runs-on: ${{ fromJSON((github.event_name == 'workflow_dispatch' && github.event.inputs.runs_on_json && (startsWith(github.event.inputs.runs_on_json, '[') && github.event.inputs.runs_on_json || format('["{0}"]', github.event.inputs.runs_on_json))) || (vars.SECURITY_ACTION_RUNS_ON_JSON && (startsWith(vars.SECURITY_ACTION_RUNS_ON_JSON, '[') && vars.SECURITY_ACTION_RUNS_ON_JSON || format('["{0}"]', vars.SECURITY_ACTION_RUNS_ON_JSON))) || '["ubuntu-latest"]') }}
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Run Ruff
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install ruff==0.14.4
          ruff check .
          ruff format --check .

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # ðŸ“Š Report Job (í†µí•© ë¦¬í¬íŠ¸)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  report:
    name: ðŸ“Š Report
    runs-on: ${{ fromJSON((github.event_name == 'workflow_dispatch' && github.event.inputs.runs_on_json && (startsWith(github.event.inputs.runs_on_json, '[') && github.event.inputs.runs_on_json || format('["{0}"]', github.event.inputs.runs_on_json))) || (vars.SECURITY_ACTION_RUNS_ON_JSON && (startsWith(vars.SECURITY_ACTION_RUNS_ON_JSON, '[') && vars.SECURITY_ACTION_RUNS_ON_JSON || format('["{0}"]', vars.SECURITY_ACTION_RUNS_ON_JSON))) || '["ubuntu-latest"]') }}
    timeout-minutes: 5
    needs: [security-scan, container-scan, lint]
    if: always()

    steps:
      - name: Generate Security Report
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          # ðŸ›¡ï¸ Security Scan Report

          ## ðŸ“ˆ Overview
          | Scan Type | Findings | Critical | High |
          |-----------|----------|----------|------|
          | ðŸ” Code & Dependencies | ${{ needs.security-scan.outputs.findings-count || 'N/A' }} | ${{ needs.security-scan.outputs.critical-count || '0' }} | ${{ needs.security-scan.outputs.high-count || '0' }} |
          | ðŸ³ Container Image | ${{ needs.container-scan.outputs.findings-count || 'N/A' }} | ${{ needs.container-scan.outputs.critical-count || '0' }} | ${{ needs.container-scan.outputs.high-count || '0' }} |

          ## ðŸ›¡ï¸ Enabled Scanners
          | Scanner | Tool | Status |
          |---------|------|--------|
          | ðŸ” Secret Scan | Gitleaks | âœ… Enabled (history on schedule) |
          | ðŸ” Code Scan (SAST) | Semgrep | âœ… Enabled |
          | ðŸ“¦ Dependency Scan (SCA) | Trivy | âœ… Enabled |
          | ðŸ—ï¸ IaC Scan | Checkov | âœ… Enabled |
          | ðŸ³ Container Scan | Trivy | âœ… Enabled |
          | ðŸ“‹ SBOM Generation | Syft | âœ… Enabled |
          | ðŸ”¬ SonarQube | SonarQube | â¸ï¸ Disabled (requires server) |
          | ðŸ¤– AI Review | LangGraph | â¸ï¸ Disabled (requires API key) |

          ## ðŸ“¦ Artifacts
          | Type | File | Description |
          |------|------|-------------|
          | SARIF | `security-results.sarif` | Static analysis results (GitHub Security íƒ­) |
          | SARIF | `container-scan.sarif` | Container vulnerabilities |
          | SBOM | `sbom.json` | Source code dependencies (CycloneDX) |
          | SBOM | `container-sbom.json` | Container image components |

          ## ðŸ”§ Workflow Status
          | Job | Status |
          |-----|--------|
          | ðŸ”§ Lint | ${{ needs.lint.result }} |

          ---

          ### ðŸ“– Quick Reference
          - **SARIF**: GitHub Security íƒ­ì—ì„œ ì·¨ì•½ì  ìƒì„¸ í™•ì¸
          - **SBOM**: ì†Œí”„íŠ¸ì›¨ì–´ êµ¬ì„±ìš”ì†Œ ëª©ë¡ (ê³µê¸‰ë§ ë³´ì•ˆ)
          - **Branch Protection**: `ðŸ›¡ï¸ Security Report`ë¥¼ Required Status Checkë¡œ ì„¤ì •

          > ðŸ’¡ SonarQube, AI Review í™œì„±í™”ëŠ” [README.md](../../README.md) ì°¸ê³ 
          EOF
