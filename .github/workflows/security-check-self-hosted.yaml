name: Security Check (Self-hosted)

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    - cron: '0 0 * * 0'  # ë§¤ì£¼ ì¼ìš”ì¼ ìžì • (UTC)
  workflow_dispatch:

concurrency:
  group: security-check-self-hosted-${{ github.ref }}
  cancel-in-progress: true

# =============================================================================
# ðŸ›¡ï¸ Security Report (Self-hosted) - Required Status Check
# This workflow is specifically for testing the action on self-hosted runners.
# =============================================================================

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # ðŸ›¡ï¸ Security Jobs
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  security-scan:
    name: ðŸ›¡ï¸ Security Scan
    runs-on: jhl-space
    permissions:
      contents: read
      pull-requests: write
      checks: write
      statuses: write

    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0

      - name: Run Security Scan
        id: scan
        uses: ./
        with:
          # ê¸°ë³¸ ìŠ¤ìºë„ˆ (ëª¨ë‘ í™œì„±í™”)
          secret-scan: 'true'
          secret-scan-history: ${{ github.event_name == 'schedule' }}
          code-scan: 'true'
          dependency-scan: 'true'

          # IaC ìŠ¤ìº”
          iac-scan: 'true'
          iac-frameworks: 'dockerfile,github_actions,kubernetes'

          # ë„¤ì´í‹°ë¸Œ ì˜ì¡´ì„± ìŠ¤ìº”
          native-audit: 'true'
          native-audit-tools: 'auto'

          # SBOM ìƒì„±
          sbom-generate: 'true'
          sbom-format: 'cyclonedx-json'
          sbom-output: 'sbom.json'

          # ê³µí†µ ì„¤ì •
          check-name: 'ðŸ›¡ï¸ Security Report (Self-hosted)'
          severity-threshold: 'high'
          fail-on-findings: 'false'
          post-summary: 'false'
          sarif-output: 'security-results.sarif'
          upload-sarif: 'false'
          sarif-category: 'security-scan-self-hosted'
          fail-on-sarif-upload-error: 'false'
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload SBOM Artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        if: always()
        with:
          name: sbom-source-self-hosted
          path: sbom.json
          retention-days: 90

      - name: Upload SARIF Artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        if: always()
        with:
          name: sarif-security-self-hosted
          path: security-results.sarif
          retention-days: 90

    outputs:
      findings-count: ${{ steps.scan.outputs.findings-count }}
      critical-count: ${{ steps.scan.outputs.critical-count }}
      high-count: ${{ steps.scan.outputs.high-count }}
      sarif-file: ${{ steps.scan.outputs.sarif-file }}
      sarif-upload-id: ${{ steps.scan.outputs.sarif-upload-id }}
      sbom-file: ${{ steps.scan.outputs.sbom-file }}

  container-scan:
    name: ðŸ›¡ï¸ Container Scan
    runs-on: jhl-space
    permissions:
      contents: read
      checks: write
      statuses: write

    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435 # v3.11.1

      - name: Build Image for Scan
        uses: docker/build-push-action@ca052bb54ab0790a636c9b5f226502c73d547a25 # v5.4.0
        with:
          context: .
          push: false
          load: true
          tags: security-action:self-hosted-scan
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Run Container Scan
        id: scan
        uses: ./
        with:
          secret-scan: 'false'
          code-scan: 'false'
          dependency-scan: 'false'
          container-scan: 'true'
          container-image: 'security-action:self-hosted-scan'
          sbom-generate: 'true'
          sbom-format: 'cyclonedx-json'
          sbom-output: 'container-sbom.json'

          # ê³µí†µ ì„¤ì •
          skip-check: 'true'
          severity-threshold: 'critical'
          fail-on-findings: 'false'
          post-summary: 'false'
          sarif-output: 'container-scan.sarif'
          upload-sarif: 'false'
          sarif-category: 'container-scan-self-hosted'
          fail-on-sarif-upload-error: 'false'
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Container SBOM Artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        if: always()
        with:
          name: sbom-container-self-hosted
          path: container-sbom.json
          retention-days: 90

      - name: Upload Container SARIF Artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        if: always()
        with:
          name: sarif-container-self-hosted
          path: container-scan.sarif
          retention-days: 90

    outputs:
      findings-count: ${{ steps.scan.outputs.findings-count }}
      critical-count: ${{ steps.scan.outputs.critical-count }}
      high-count: ${{ steps.scan.outputs.high-count }}
      sarif-upload-id: ${{ steps.scan.outputs.sarif-upload-id }}

  lint:
    name: ðŸ”§ Lint
    runs-on: jhl-space
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Run Ruff
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install ruff==0.14.4
          ruff check .
          ruff format --check .

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # ðŸ“Š Report Job (í†µí•© ë¦¬í¬íŠ¸)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  report:
    name: ðŸ“Š Report
    runs-on: jhl-space
    needs: [security-scan, container-scan, lint]
    if: always()

    steps:
      - name: Generate Security Report
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          # ðŸ›¡ï¸ Security Scan Report (Self-hosted)

          ## ðŸ“ˆ Overview
          | Scan Type | Findings | Critical | High |
          |-----------|----------|----------|------|
          | ðŸ” Code & Dependencies | ${{ needs.security-scan.outputs.findings-count || 'N/A' }} | ${{ needs.security-scan.outputs.critical-count || '0' }} | ${{ needs.security-scan.outputs.high-count || '0' }} |
          | ðŸ³ Container Image | ${{ needs.container-scan.outputs.findings-count || 'N/A' }} | ${{ needs.container-scan.outputs.critical-count || '0' }} | ${{ needs.container-scan.outputs.high-count || '0' }} |

          ## ðŸ›¡ï¸ Enabled Scanners
          | Scanner | Tool | Status |
          |---------|------|--------|
          | ðŸ” Secret Scan | Gitleaks | âœ… Enabled (history on schedule) |
          | ðŸ” Code Scan (SAST) | Semgrep | âœ… Enabled |
          | ðŸ“¦ Dependency Scan (SCA) | Trivy | âœ… Enabled |
          | ðŸ—ï¸ IaC Scan | Checkov | âœ… Enabled |
          | ðŸ³ Container Scan | Trivy | âœ… Enabled |
          | ðŸ“‹ SBOM Generation | Syft | âœ… Enabled |

          ## ðŸ“¦ Artifacts
          | Type | File | Description |
          |------|------|-------------|
          | SARIF | `security-results.sarif` | Static analysis results |
          | SARIF | `container-scan.sarif` | Container vulnerabilities |
          | SBOM | `sbom.json` | Source code dependencies |
          | SBOM | `container-sbom.json` | Container image components |

          ## ðŸ”§ Workflow Status
          | Job | Status |
          |-----|--------|
          | ðŸ”§ Lint | ${{ needs.lint.result }} |

          ---
          *Executed on self-hosted runner: `jhl-space`*
          EOF
